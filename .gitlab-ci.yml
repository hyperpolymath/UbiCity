# GitLab CI/CD for UbiCity (RSR-Compliant)

stages:
  - lint
  - build
  - test
  - verify
  - deploy

variables:
  DENO_VERSION: "1.40.0"
  RUST_VERSION: "1.75.0"
  NODE_VERSION: "20"

# Templates
.deno-base:
  image: denoland/deno:${DENO_VERSION}
  before_script:
    - deno --version

.rust-base:
  image: rust:${RUST_VERSION}
  before_script:
    - rustc --version
    - cargo --version
    - rustup target add wasm32-unknown-unknown

# Lint Stage
lint:deno:
  extends: .deno-base
  stage: lint
  script:
    - deno lint
    - deno fmt --check
  allow_failure: false

lint:rust:
  extends: .rust-base
  stage: lint
  script:
    - cd wasm
    - cargo fmt -- --check
    - cargo clippy -- -D warnings
  allow_failure: false

# Build Stage
build:rescript:
  image: node:${NODE_VERSION}
  stage: build
  before_script:
    - npm install -g rescript
  script:
    - rescript build
  artifacts:
    paths:
      - src-rescript/**/*.res.js
    expire_in: 1 hour

build:wasm:
  extends: .rust-base
  stage: build
  script:
    - cd wasm
    - cargo build --release --target wasm32-unknown-unknown
    - ls -lh target/wasm32-unknown-unknown/release/
  artifacts:
    paths:
      - wasm/target/wasm32-unknown-unknown/release/*.wasm
    expire_in: 1 hour
  cache:
    key: ${CI_COMMIT_REF_SLUG}-rust
    paths:
      - wasm/target/

# Test Stage
test:unit:
  extends: .deno-base
  stage: test
  dependencies:
    - build:rescript
    - build:wasm
  script:
    - deno test --allow-read --allow-write tests/
  coverage: '/\d+\.\d+% coverage/'

test:integration:
  extends: .deno-base
  stage: test
  dependencies:
    - build:rescript
    - build:wasm
  script:
    - deno run --allow-read --allow-write src/cli.ts stats
    - deno run --allow-read --allow-write src/cli.ts help
  allow_failure: false

# Verify Stage (RSR Compliance)
verify:rsr-compliance:
  extends: .deno-base
  stage: verify
  script:
    - |
      echo "üîç RSR Compliance Verification"
      echo "=============================="

      # Check required files
      echo "Checking required files..."
      test -f LICENSE.txt && echo "‚úÖ LICENSE.txt" || (echo "‚ùå LICENSE.txt missing" && exit 1)
      test -f README.md && echo "‚úÖ README.md" || (echo "‚ùå README.md missing" && exit 1)
      test -f CONTRIBUTING.md && echo "‚úÖ CONTRIBUTING.md" || (echo "‚ùå CONTRIBUTING.md missing" && exit 1)
      test -f CODE_OF_CONDUCT.md && echo "‚úÖ CODE_OF_CONDUCT.md" || (echo "‚ùå CODE_OF_CONDUCT.md missing" && exit 1)
      test -f MAINTAINERS.md && echo "‚úÖ MAINTAINERS.md" || (echo "‚ùå MAINTAINERS.md missing" && exit 1)
      test -f CHANGELOG.md && echo "‚úÖ CHANGELOG.md" || (echo "‚ùå CHANGELOG.md missing" && exit 1)

      # Check .well-known directory
      echo "Checking .well-known directory..."
      test -f .well-known/security.txt && echo "‚úÖ security.txt" || (echo "‚ùå security.txt missing" && exit 1)
      test -f .well-known/ai.txt && echo "‚úÖ ai.txt" || (echo "‚ùå ai.txt missing" && exit 1)
      test -f .well-known/humans.txt && echo "‚úÖ humans.txt" || (echo "‚ùå humans.txt missing" && exit 1)

      # Check build system
      echo "Checking build system..."
      test -f justfile && echo "‚úÖ justfile" || (echo "‚ùå justfile missing" && exit 1)
      test -f deno.json && echo "‚úÖ deno.json" || (echo "‚ùå deno.json missing" && exit 1)
      test -f flake.nix && echo "‚úÖ flake.nix" || (echo "‚ùå flake.nix missing" && exit 1)

      # Check type safety
      echo "Checking type safety..."
      deno check src/**/*.ts && echo "‚úÖ TypeScript type-safe" || (echo "‚ùå Type errors found" && exit 1)
      test -f wasm/Cargo.toml && echo "‚úÖ Rust WASM present" || (echo "‚ùå WASM missing" && exit 1)
      test -f src-rescript/UbiCity.res && echo "‚úÖ ReScript present" || (echo "‚ùå ReScript missing" && exit 1)

      echo ""
      echo "‚úÖ RSR Compliance: PASSED"
      echo "Tier: Bronze (minimum requirements met)"
  allow_failure: false

verify:offline-first:
  extends: .deno-base
  stage: verify
  script:
    - |
      echo "üîå Offline-First Verification"
      echo "============================="

      # Verify no network calls in source
      echo "Checking for network calls..."
      ! grep -r "fetch(" src/ && echo "‚úÖ No fetch() calls" || (echo "‚ùå Found fetch() calls" && exit 1)
      ! grep -r "https://" src/ && echo "‚úÖ No HTTP URLs in source" || echo "‚ö†Ô∏è  HTTP URLs found (check if documentation)"
      ! grep -r "https://" src/ && echo "‚úÖ No HTTPS URLs in source" || echo "‚ö†Ô∏è  HTTPS URLs found (check if documentation)"

      echo ""
      echo "‚úÖ Offline-First: VERIFIED"

verify:security:
  extends: .deno-base
  stage: verify
  script:
    - |
      echo "üîí Security Verification"
      echo "======================="

      # Check Deno permissions
      echo "Checking Deno permission model..."
      grep -q "allow-read" deno.json && echo "‚úÖ Explicit read permissions" || echo "‚ö†Ô∏è  No read permissions specified"
      grep -q "allow-write" deno.json && echo "‚úÖ Explicit write permissions" || echo "‚ö†Ô∏è  No write permissions specified"

      # Verify no unsafe Rust
      echo "Checking Rust safety..."
      ! grep -r "unsafe" wasm/src/ && echo "‚úÖ No unsafe Rust blocks" || (echo "‚ùå Unsafe Rust found" && exit 1)

      # Check for sensitive data patterns
      echo "Checking for hardcoded secrets..."
      ! grep -ri "password\s*=" src/ && echo "‚úÖ No hardcoded passwords" || echo "‚ö†Ô∏è  Possible hardcoded password"
      ! grep -ri "api_key\s*=" src/ && echo "‚úÖ No hardcoded API keys" || echo "‚ö†Ô∏è  Possible hardcoded API key"

      echo ""
      echo "‚úÖ Security: VERIFIED"

# Deploy Stage (for releases)
deploy:pages:
  extends: .deno-base
  stage: deploy
  only:
    - tags
  script:
    - deno run --allow-read --allow-write src/visualize.ts
    - mkdir -p public
    - cp ubicity-data/ubicity-map.html public/index.html
  artifacts:
    paths:
      - public
  environment:
    name: production
    url: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME

# Release compilation (for tags)
compile:release:
  extends: .deno-base
  stage: deploy
  only:
    - tags
  dependencies:
    - build:rescript
    - build:wasm
  script:
    - deno compile --allow-read --allow-write --output ./bin/ubicity src/cli.ts
    - deno compile --allow-read --allow-write --output ./bin/ubicity-capture src/capture.ts
    - ls -lh ./bin/
  artifacts:
    paths:
      - bin/
    expire_in: 1 year

# Nightly builds
nightly:
  extends: .deno-base
  stage: build
  only:
    - schedules
  dependencies:
    - build:rescript
    - build:wasm
  script:
    - deno compile --allow-read --allow-write --output ./bin/ubicity-nightly src/cli.ts
  artifacts:
    paths:
      - bin/
    expire_in: 7 days
